/*
  This javascript is added to norms page while creating an assessment
  Checkboxes to select factors are disabled by default.
  On document ready  
  enable all checkboxes for factors
  Add change even on checkboxes to select factor
  On checked, enable all input tags under that factor_norm
  On Uncheck, if factor_norm is new then disable all input tags under that factor_norm, else mark as destroy
  Also toggle checked class for li tag for that factor
  
  For checkboxes to mark a factor as critical,
  on checked, set value of hidden critical field as on
  on uncheck, set value of hidden critical field as off
*/

jQuery(document).ready(function($) {
  $("input[name='selected_factor']").removeAttr("disabled");
  $("input[name='selected_factor']").change(function() {
    var index = $(this).attr("index");
    if ($(this).is(":checked")) {
      $("input:not(:checkbox)[index='" + index + "']").removeAttr("disabled");
      $("select[index='" + index + "']").removeAttr("disabled");
      $("#critical_checkbox_" + index).removeAttr("disabled");
      $("#li_" + index).addClass("checked");
    } else {
      var id = $("#id_" + index).val();
      if (id != null && id != "") {
          $("#destroy_" + index).val(true);
      } else {
          $("input:not(:checkbox)[index='" + index + "']").attr("disabled", 'disabled');
          $("select[index='" + index + "']").attr("disabled", 'disabled');
          $("#critical_checkbox_" + index).attr("disabled", 'disabled');
          $("#li_" + index).removeClass("checked");
      }
    }
  });

  /*
    Disable proceed btn on submit to avoid multiple post requests
  */

  $("input[name='checkbox_critical']").change(function() {
    var index = $(this).attr("index");
    if ($(this).is(":checked")) {
      $("#critical_" + index).val("on");
    } else {
      $("#critical_" + index).val("off");
    }
  });

  $("#check_all").change(function() {
    $(".check_factor").prop("checked", $(this).is(":checked"));
    $(".check_factor").trigger("change");
  });

  var traits_min = <%= Rails.application.config.validators["traits_range"]["min"] %>;
  $('#edit_assessment').submit(function() {
      if ($('input[name=selected_factor]:checked').length >= parseInt(traits_min)) {
          $('#edit_assessment button').attr("disabled", "disabled");
          return true;
      } else {
          $("#trait_flag").removeAttr('hidden');
          return false;
      }
  });

  // To check the number of traits selected//
  var approximate_time_per_factor = <%= Rails.application.config.validators["approx_time_per_trait"]%>;
  var traits_selected_counter = parseInt($('input[name="selected_factor"]:checked').length);  
  var approximate_time = traits_selected_counter * approximate_time_per_factor; //total time in seconds
  var approximate_time_sec = approximate_time % 60; // 120sec % 60sec = 0seconds
  var approximate_time_min = parseInt(approximate_time / 60); // 120sec / 60 = 2mins
  
  $("#traits-counter").html(traits_selected_counter);
  $("#approximate-time").html(approximate_time_min+" min : "+approximate_time_sec+" sec");

  $('input[name="selected_factor"]').on("change",function(){
    if($(this).is(":checked")){
      traits_selected_counter += 1;
      approximate_time = traits_selected_counter * 30;
      approximate_time_sec = approximate_time % 60; // 120sec % 60sec = 0seconds
      approximate_time_min = parseInt(approximate_time / 60); // 120sec / 60 = 2mins
      $("#traits-counter").html(traits_selected_counter);
      $("#approximate-time").html(approximate_time_min+" mins : "+approximate_time_sec+" sec");
    }
    else
    {
      traits_selected_counter -= 1;
      approximate_time = traits_selected_counter * 30;
      approximate_time_sec = approximate_time % 60; // 120sec % 60sec = 0seconds
      approximate_time_min = parseInt(approximate_time / 60); // 120sec / 60 = 2mins
      $("#traits-counter").html(traits_selected_counter);
      $("#approximate-time").html(approximate_time_min+" min : "+approximate_time_sec+" sec");
    }
  });

});
